# Epic 4 Retrospective — Global Analysis & Comparison

**Date:** 2026-02-12
**Epic:** Epic 4 - Global Analysis & Comparison
**Status:** ALL 3 STORIES DONE — Epic complete
**Previous Retro:** epic-3-retro-2026-02-11.md (Phase 2)
**Participants:** JB (Project Lead), Bob (Scrum Master), Alice (Product Owner), Charlie (Senior Dev), Dana (QA Engineer), Elena (Junior Dev)

---

## Executive Summary

Epic 4 delivered the "power moment" — aggregated ROI metrics and side-by-side comparison table for the Global Analysis view. All 3 stories completed without blockers, zero corrective stories needed, zero technical debt introduced. This is the cleanest epic in the project's history.

**Key Outcome:** 3/3 stories done, 126 new tests (889 → 1015), 13 code review issues found and fixed (4 HIGH, 9 MEDIUM), zero production incidents. Epic 3 retrospective action items followed through at 6/7 (86%).

**JB Assessment:** "L'epic 4 a ete clean, pas de surprise, les tests sont solides."

---

## Epic 4 Metrics

| Metric | Value |
|--------|-------|
| **Total Stories** | 3 |
| **Stories Done** | 3/3 (100%) |
| **Corrective Stories** | 0 (vs. 7 in Epic 3) |
| **Test Count** | 889 → 1015 (+126 tests, +14%) |
| **Tests vs. Estimates** | 126 actual vs. 101 estimated (+25%) |
| **Files Modified** | 23 (12 NEW, 11 MODIFIED) |
| **Code Review Issues** | 4 HIGH + 9 MEDIUM → 100% fixed |
| **Technical Debt Added** | 0 |
| **Blockers** | 0 |
| **Production Incidents** | 0 |
| **FRs Delivered** | FR35, FR36, FR37, FR38 (100%) |

### Per-Story Breakdown

| Story | Tests Added | Estimated | Files | Code Review |
|-------|------------|-----------|-------|-------------|
| 4.1 — Global Analysis View | 43 | ~32 | 10 (6 NEW, 4 MOD) | 0 HIGH, 3 MEDIUM |
| 4.2 — Comparison Table | 43 | ~36 | 9 (3 NEW, 6 MOD) | 0 HIGH, 4 MEDIUM |
| 4.3 — Navigation & Stability | 40 | ~33 | 4 (3 NEW, 1 MOD) | 4 HIGH, 2 MEDIUM |

---

## Epic 3 Retro Action Items — Follow-Through

| # | Action Item | Status | Evidence in Epic 4 |
|---|------------|--------|---------------------|
| 1 | Fix What-If input focus loss (CRITICAL) | Done (Story 3-12) | No similar bug in Epic 4 |
| 2 | Fix/remove "Analyse active" French badge | Done (Story 3-13) | English UI confirmed |
| 3 | Fix 54 failing tests (French labels) | Done (Story 3-13) | 889 tests pass before Epic 4 |
| 4 | Update story file statuses | Partial | sprint-status correct, some story files not updated |
| 5 | Update epic-3 status to done | Done | epic-3: done in sprint-status |
| 6 | Commit discipline: no cross-story imports | Applied | Zero cross-story imports in Epic 4 |
| 7 | Fix failing tests immediately | Applied | Zero failing tests carried between stories |

**Result: 6/7 action items completed or applied (86%)**

---

## Successes — What Went Well

### 1. Cleanest Epic in Project History
Zero corrective stories needed. Compare: Epic 3 required 7 corrective stories (3-5 through 3-11) on top of 4 original stories. Epic 4 delivered 3/3 stories clean on first pass.

### 2. Code Reviews Found Real Issues
13 issues across 3 stories (4 HIGH, 9 MEDIUM), all fixed before merge. Story 4.3 review found 4 HIGH issues — missing tests for FocusSidebar highlight, NavBar click-back, selective re-render, and build/lint verification. Without adversarial review, these coverage gaps would have shipped.

### 3. Tests Consistently Exceeded Estimates
Every story delivered 25-35% more tests than estimated. This indicates thorough development and mature testing practices.

### 4. Epic 3 Lessons Successfully Applied
- Commit discipline maintained (no cross-story imports)
- Failing tests fixed immediately (zero carried between stories)
- Story files comprehensive with Dev Notes, Code Review records, Completion Notes
- Definition of Done checklist applied consistently

### 5. Solid Architectural Foundations
- `calculateAggregatedMetrics()` pure function pattern from 4.1 reused in 4.2 and will be reused in Epic 5 PDF
- `calculateAllAnalysisRows()` established reusable per-analysis calculation pattern
- ComparisonTable sorting pattern (local state + useMemo) is clean and reusable
- Zustand store confirmed rock-solid by stress tests (Story 4.3)

---

## Challenges — Minor Issues

### 1. MemoryRouter Wrapping in Tests (Recurring)
When components use `useNavigate`, existing tests break without `MemoryRouter` wrapper. Encountered in Story 4.1 and 4.2. Not a major issue but causes friction.

### 2. Fragile Test Selectors
Stories 4.1 and 4.2 had `getByText(/%/)` and single-digit selectors that broke when the same value appeared in multiple components (hero + table). Fixed with `within()` queries during code review.

### 3. Missing Tests Found in Review (Story 4.3)
4 HIGH issues in Story 4.3 code review were all missing tests. The testing story itself had testing gaps — ironic but caught by the review process.

**JB Assessment:** "C'est du bruit normal, l'epic etait clean."

---

## Key Insights

1. **Process maturity pays off** — The improvements committed in Epic 3 retro (commit discipline, immediate test fixes, adversarial reviews) directly contributed to Epic 4's clean execution
2. **Adversarial code reviews are non-negotiable** — 13 real issues found across 3 stories. Without them, quality would degrade
3. **Pure function patterns create compounding value** — Calculation functions built in Epic 4 will be directly reused in Epic 5 PDF content generation
4. **Testing verification stories are valuable** — Story 4.3 (40 tests, no production code) confirmed session stability, memory management, and navigation integrity

---

## Significant Change Detection

**No significant discoveries that impact Epic 5 plan.**

- All Epic 4 work is stable and ready to build upon
- `calculateAggregatedMetrics()` and `calculateAllAnalysisRows()` are tested and production-ready for PDF content
- Navigation is verified stable (Story 4.3)
- jsPDF + html2canvas already in dependencies since project initialization

**Epic Update Required: NO** — Epic 5 plan remains valid as-is.

---

## Action Items

### Process (Maintain)

| # | Action | Owner | Criteria |
|---|--------|-------|----------|
| 1 | Continue adversarial code reviews (3 parallel reviewers) | Team | Applied on every story |
| 2 | Document MemoryRouter requirement in story templates | Bob (SM) | Mentioned in Dev Notes for navigation stories |
| 3 | Prefer `within()` queries over global `getByText` selectors | Team | No fragile selectors found in code review |

### Technical

| # | Action | Owner | Criteria |
|---|--------|-------|----------|
| 4 | Update epic-4 status to done in sprint-status.yaml | Bob (SM) | `epic-4: done` |

### Documentation

| # | Action | Owner | Criteria |
|---|--------|-------|----------|
| 5 | Update CLAUDE.md with test count (1015) and Epic 4 status | Bob (SM) | CLAUDE.md reflects current state |

---

## Preparation for Epic 5

### Epic 5: PDF Export & Reporting (4 stories)
- 5-1: PDF Export Button with Progress State (FR39)
- 5-2: PDF Template with Pfeiffer Branding (FR40)
- 5-3: PDF Content Structure — Executive Summary, Breakdown, Assumptions (FR41-44)
- 5-4: PDF Generation Error Handling (FR58, NFR-R2, NFR-R3)

### Prerequisites — All Met
- Multiple analyses functional (Epic 2 + 3) ✅
- Global Analysis with aggregated metrics (Story 4.1) ✅
- Comparison Table with per-analysis data (Story 4.2) ✅
- Navigation stable and verified (Story 4.3) ✅
- jsPDF 4.1 + html2canvas 1.4 in dependencies ✅
- Pfeiffer branding assets in project (Epic 1) ✅
- Calculation functions ready for PDF content ✅

### No Blocking Preparation Needed
JB confirmed: "On est bien prepares, jsPDF c'est standard, on y va."

---

## Team Agreements

- Continue adversarial code reviews (proven effective across 4 epics)
- Maintain commit discipline and immediate test fixes
- Prefer `within()` queries in tests to avoid fragile selectors
- Document MemoryRouter requirements in story Dev Notes
- No preparation sprint needed before Epic 5

---

## Next Steps

1. **Update sprint-status.yaml**: epic-4 → done, epic-4-retrospective → done
2. **Begin Epic 5 sprint planning**: Create story files for 5-1 through 5-4
3. **Start development**: No blocking prerequisites

---

## Retrospective Status

**Document Status:** COMPLETE
**Facilitator:** Bob (Scrum Master)
**Document Author:** Claude Opus 4.6
**Epic 4 Status:** 3/3 stories done, epic complete
**Next Epic:** Epic 5 - PDF Export & Reporting
